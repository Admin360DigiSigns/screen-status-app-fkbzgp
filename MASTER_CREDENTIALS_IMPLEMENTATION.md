
# Master Credentials Implementation Summary

## Overview
This document explains how the app now uses **master credentials** (username, password, screen name) consistently across all authentication and command operations.

## Key Changes

### 1. **Unified Supabase Project**
- **Before**: The app was using TWO different Supabase projects:
  - `gzyywcqlrjimjegbtoyc` for login/connect
  - `pgcdokfiaarnhzryfzwf` for registration and commands
- **After**: ALL operations now use the **MASTER project**: `pgcdokfiaarnhzryfzwf`

### 2. **Master Credentials Flow**

#### Login/Registration Flow:
1. User enters **master credentials** (username, password, screen name)
2. App generates a unique **device ID** automatically
3. App attempts to **login** with master credentials + device ID
4. If login fails (invalid credentials), app automatically **registers** the display with master credentials + device ID
5. Master credentials are stored locally and used for ALL subsequent operations

#### Status Updates:
- Every 1 minute (when on home screen), the app sends status updates
- Status updates include:
  - Device ID (generated by app)
  - Screen Name (from master credentials)
  - Username (from master credentials)
  - Password (from master credentials)
  - Status (online/offline)
  - Timestamp

#### Command Execution:
- Commands are sent from the web app to the device using screen_name or device_id
- Commands are received via:
  1. **Realtime** (instant delivery via Supabase Realtime)
  2. **Polling** (fallback, every 3 seconds)
- When a command is received, it's executed immediately
- Command status is updated (pending → processing → completed/failed)

### 3. **Updated Files**

#### `utils/apiService.ts`
- All API endpoints now use the MASTER project URL
- Login, registration, status updates, and content fetching all use master credentials
- Comprehensive logging for debugging

#### `utils/supabaseClient.ts`
- Supabase client now connects to the MASTER project
- All Realtime subscriptions use the master project

#### `contexts/AuthContext.tsx`
- Master credentials are stored in AsyncStorage
- Master credentials are used for all API calls
- Status updates include all master credentials
- Comprehensive logging for debugging

#### `app/login.tsx`
- Updated UI to explain master credentials concept
- Auto-registration flow clearly explained
- Better error handling and user feedback

#### Edge Function: `display-connect`
- Updated to accept device_id parameter
- Validates master credentials (username, password, screen name)
- Updates device_id and last_seen timestamp
- Returns success/error response

### 4. **Command Execution Flow**

#### Web App → Display App:
1. Web app calls `send-app-command` Edge Function with:
   - `screen_name` (from master credentials)
   - `command` (preview_content, screenshare, sync_status, logout)
   - Optional `payload`

2. Edge Function:
   - Creates command in `app_commands` table
   - Broadcasts command via Realtime channel
   - Returns success response

3. Display App:
   - Receives command via Realtime (instant) OR polling (every 3 seconds)
   - Executes command handler
   - Updates command status to "processing" → "completed"/"failed"

#### Supported Commands:
- **preview_content**: Opens content preview modal
- **screenshare**: Opens screen share receiver (mobile/TV only)
- **sync_status**: Manually syncs device status
- **logout**: Logs out the display

### 5. **Database Tables**

#### `displays` table:
- `screen_username` (master credential)
- `screen_password` (master credential)
- `screen_name` (master credential)
- `device_id` (generated by app)
- `status` (online/offline)
- `last_seen` (timestamp)

#### `app_commands` table:
- `device_id` (target device)
- `screen_name` (target screen)
- `command` (command type)
- `status` (pending/processing/completed/failed)
- `payload` (command data)
- `created_at`, `updated_at`, `executed_at`
- `error_message` (if failed)

## Testing the Implementation

### 1. **Test Login/Registration**
1. Open the app
2. Enter username, password, and screen name
3. Click "Login / Register"
4. If first time: Display should be registered automatically
5. If already registered: Display should login successfully
6. Check console logs for detailed flow

### 2. **Test Status Updates**
1. Login to the app
2. Navigate to home screen
3. Wait 1 minute
4. Check console logs for status update
5. Verify status is sent with all master credentials

### 3. **Test Command Execution**
1. Login to the app
2. Open web app (TEST_COMMAND_API.html)
3. Enter the screen name
4. Click one of the command buttons (Preview, Screen Share, Sync, Logout)
5. Check app console logs for command reception and execution
6. Verify command is executed on the display

### 4. **Test Diagnostics**
1. Login to the app
2. Click "Diagnostics" button
3. View command history
4. Test command listener
5. Check connection status

## Troubleshooting

### Commands Not Working?
1. Check that display is registered (login successful)
2. Check that device_id is set correctly
3. Check command listener status (should be "Connected")
4. Check console logs for command reception
5. Verify screen_name matches exactly

### Status Updates Not Sending?
1. Check that you're on the home screen (status updates only when active)
2. Check console logs for status update attempts
3. Verify all master credentials are stored
4. Check network connection

### Auto-Registration Not Working?
1. Check internet connection
2. Verify all fields are filled
3. Check console logs for registration errors
4. Verify Supabase project is accessible

## Key Benefits

1. **Single Source of Truth**: Master credentials are the only authentication mechanism
2. **Automatic Registration**: No manual setup required - just enter credentials
3. **Consistent Authentication**: All operations use the same credentials
4. **Device Identification**: Device ID is generated automatically and associated with credentials
5. **Command Reliability**: Multiple delivery mechanisms (Realtime + Polling)
6. **Comprehensive Logging**: Easy to debug issues with detailed console logs

## Important Notes

- **Master credentials** (username, password, screen name) must be entered correctly
- **Device ID** is generated automatically by the app
- **Status updates** are sent every 1 minute when on the home screen
- **Commands** are received via Realtime (instant) or polling (every 3 seconds)
- **All operations** use the MASTER Supabase project (`pgcdokfiaarnhzryfzwf`)
